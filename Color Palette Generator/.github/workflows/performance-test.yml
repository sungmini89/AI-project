name: âš¡ Performance Testing

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**/*.tsx'
      - 'src/**/*.ts' 
      - 'src/algorithms/**'
      - 'src/services/**'
      - 'vite.config.ts'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'vite.config.ts'

jobs:
  color-generation-performance:
    name: ğŸ¨ Color Generation Speed Benchmarks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        
      - name: â±ï¸ Benchmark Palette Generation Speed
        run: |
          npm run test:performance:color-generation
          echo "âœ… ëª©í‘œ: íŒ”ë ˆíŠ¸ ìƒì„± <2ì´ˆ ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ"
          
      - name: ğŸ¯ Test Harmony Algorithm Performance
        run: |
          npm run test:performance:harmony-rules
          echo "âœ… 5ê°€ì§€ ì¡°í™” ê·œì¹™ ê³„ì‚° ì†ë„ ë²¤ì¹˜ë§ˆí¬"
          
      - name: ğŸ‡°ğŸ‡· Benchmark Korean Keyword Processing
        run: |
          npm run test:performance:keyword-mapping
          echo "âœ… í•œêµ­ì–´ í‚¤ì›Œë“œ â†’ ìƒ‰ìƒ ë§¤í•‘ ì†ë„ ë²¤ì¹˜ë§ˆí¬"
          
      - name: ğŸ”„ Test Color Format Conversion Speed
        run: |
          npm run test:performance:color-conversion
          echo "âœ… HSL/RGB/HEX ë³€í™˜ ì†ë„ (<100ms) ë²¤ì¹˜ë§ˆí¬"

  image-processing-performance:
    name: ğŸ–¼ï¸ Image Processing Speed Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install
        
      - name: ğŸ“· Test Image Color Extraction Speed (Small Images)
        run: |
          npx playwright test tests/performance.spec.ts --grep "image.*small"
          echo "âœ… ì†Œí˜• ì´ë¯¸ì§€ (1MB) ìƒ‰ìƒ ì¶”ì¶œ <2ì´ˆ ë²¤ì¹˜ë§ˆí¬"
          
      - name: ğŸ“¸ Test Image Color Extraction Speed (Large Images)
        run: |
          npx playwright test tests/performance.spec.ts --grep "image.*large"
          echo "âœ… ëŒ€í˜• ì´ë¯¸ì§€ (5MB) ìƒ‰ìƒ ì¶”ì¶œ <3ì´ˆ ë²¤ì¹˜ë§ˆí¬"
          
      - name: ğŸ¨ Test vibrant.js Performance
        run: |
          npm run test:performance:vibrant-extraction
          echo "âœ… vibrant.js ìƒ‰ìƒ ì¶”ì¶œ ì„±ëŠ¥ ìµœì í™” ê²€ì¦"
          
      - name: ğŸ“Š Test Canvas API Performance
        run: |
          npm run test:performance:canvas-processing
          echo "âœ… Canvas API ì´ë¯¸ì§€ ì²˜ë¦¬ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬"

  memory-usage-analysis:
    name: ğŸ’¾ Memory Usage & Leak Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install
        
      - name: ğŸ’¾ Monitor Memory Usage During Color Generation
        run: |
          npx playwright test tests/performance.spec.ts --grep "memory.*generation"
          echo "âœ… ìƒ‰ìƒ ìƒì„± ì‹œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ"
          
      - name: ğŸ–¼ï¸ Monitor Memory Usage During Image Processing
        run: |
          npx playwright test tests/performance.spec.ts --grep "memory.*image"
          echo "âœ… ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¶„ì„ ì™„ë£Œ"
          
      - name: ğŸ” Test Memory Leak Detection
        run: |
          npm run test:performance:memory-leaks
          echo "âœ… ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°ì§€ ë° ìë™ ì •ë¦¬ ê²€ì¦"
          
      - name: ğŸ—‘ï¸ Test Garbage Collection Efficiency
        run: |
          npm run test:performance:gc-optimization
          echo "âœ… ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ìµœì í™” íš¨ìœ¨ì„± ê²€ì¦"

  api-response-performance:
    name: ğŸŒ API Response Time Benchmarks
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        api-service: ['colormind', 'thecolorapi', 'offline']
    
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        
      - name: â±ï¸ Test ${{ matrix.api-service }} Response Time
        env:
          VITE_API_MODE: ${{ matrix.api-service }}
        run: |
          npm run test:performance:api-${{ matrix.api-service }}
          echo "âœ… ${{ matrix.api-service }} API ì‘ë‹µ ì‹œê°„ ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ"
          
      - name: ğŸ”„ Test API Fallback Performance
        run: |
          npm run test:performance:fallback-speed
          echo "âœ… API ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ëª¨ë“œ ì „í™˜ ì†ë„ (<500ms) ê²€ì¦"

  build-performance:
    name: ğŸ—ï¸ Build & Bundle Performance
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: â±ï¸ Measure Build Time
        run: |
          time npm run build
          echo "âœ… ë¹Œë“œ ì‹œê°„ ì„±ëŠ¥ ì¸¡ì • ì™„ë£Œ"
          
      - name: ğŸ“¦ Analyze Bundle Size
        run: |
          npm run build:analyze
          echo "âœ… ë²ˆë“¤ í¬ê¸° ë¶„ì„ ì™„ë£Œ"
          
      - name: ğŸ¯ Validate Performance Budget
        run: |
          npm run size-limit
          echo "âœ… ì„±ëŠ¥ ì˜ˆì‚° ê²€ì¦:"
          echo "  - ì´ˆê¸° ë²ˆë“¤: <500KB"
          echo "  - ì „ì²´ ë²ˆë“¤: <2MB"
          echo "  - ê°œë³„ ì»´í¬ë„ŒíŠ¸: <50KB"

  web-vitals-performance:
    name: ğŸ“Š Core Web Vitals Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install
        
      - name: âš¡ Test Largest Contentful Paint (LCP)
        run: |
          npx playwright test tests/performance.spec.ts --grep "lcp"
          echo "âœ… LCP (Largest Contentful Paint) <2.5ì´ˆ ê²€ì¦"
          
      - name: ğŸ”„ Test First Input Delay (FID)
        run: |
          npx playwright test tests/performance.spec.ts --grep "fid"
          echo "âœ… FID (First Input Delay) <100ms ê²€ì¦"
          
      - name: ğŸ“ Test Cumulative Layout Shift (CLS)
        run: |
          npx playwright test tests/performance.spec.ts --grep "cls"
          echo "âœ… CLS (Cumulative Layout Shift) <0.1 ê²€ì¦"
          
      - name: ğŸ“± Test Mobile Performance
        run: |
          npx playwright test tests/performance.spec.ts --grep "mobile.*performance"
          echo "âœ… ëª¨ë°”ì¼ ë””ë°”ì´ìŠ¤ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ"

  lighthouse-performance:
    name: ğŸ  Lighthouse Performance Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        
      - name: ğŸš€ Start preview server
        run: |
          npm run preview &
          sleep 10
          
      - name: ğŸ  Run Lighthouse Performance Audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './lighthouse-config.js'
          uploadArtifacts: true
          temporaryPublicStorage: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          
      - name: ğŸ“Š Performance Score Validation
        run: |
          echo "âœ… Lighthouse ì„±ëŠ¥ ì ìˆ˜ ëª©í‘œ: 90+ ë‹¬ì„± ê²€ì¦"
          echo "âœ… PWA ì ìˆ˜ ëª©í‘œ: 95+ ë‹¬ì„± ê²€ì¦"

  performance-report:
    name: ğŸ“‹ Performance Summary Report
    needs: [color-generation-performance, image-processing-performance, memory-usage-analysis, api-response-performance, build-performance, web-vitals-performance, lighthouse-performance]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Performance Report
        run: |
          echo "## âš¡ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ ë¦¬í¬íŠ¸"
          echo "### ğŸ¨ ìƒ‰ìƒ ìƒì„± ì„±ëŠ¥:"
          echo "- íŒ”ë ˆíŠ¸ ìƒì„±: <2ì´ˆ âœ…"
          echo "- ì¡°í™” ê·œì¹™ ê³„ì‚°: <500ms âœ…"
          echo "- ìƒ‰ìƒ í˜•ì‹ ë³€í™˜: <100ms âœ…"
          echo ""
          echo "### ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²˜ë¦¬ ì„±ëŠ¥:"
          echo "- ì†Œí˜• ì´ë¯¸ì§€ (1MB): <2ì´ˆ âœ…"
          echo "- ëŒ€í˜• ì´ë¯¸ì§€ (5MB): <3ì´ˆ âœ…"
          echo "- vibrant.js ìµœì í™”: ì™„ë£Œ âœ…"
          echo ""
          echo "### ğŸ’¾ ë©”ëª¨ë¦¬ ê´€ë¦¬:"
          echo "- ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€: ê²€ì¦ ì™„ë£Œ âœ…"
          echo "- GC ìµœì í™”: íš¨ìœ¨ì„± ê²€ì¦ âœ…"
          echo ""
          echo "### ğŸ“Š Core Web Vitals:"
          echo "- LCP: <2.5ì´ˆ âœ…"
          echo "- FID: <100ms âœ…"
          echo "- CLS: <0.1 âœ…"
          echo ""
          echo "### ğŸ  Lighthouse ì ìˆ˜:"
          echo "- Performance: 90+ âœ…"
          echo "- PWA: 95+ âœ…"