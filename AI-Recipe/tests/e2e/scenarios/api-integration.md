# API 통합 및 에러 처리 E2E 테스트 시나리오

## 개요
**시나리오 이름**: API 통합 및 에러 처리 테스트  
**우선순위**: High  
**카테고리**: API 통합  
**예상 실행 시간**: 15-20분  
**복잡도**: High  

## 목적
- 외부 API (Spoonacular, Edamam, Custom AI) 연동 상태 검증
- API 키 유효성 검사 기능 테스트
- 다양한 API 실패 시나리오 및 에러 핸들링 검증
- API 응답 타임아웃 및 재시도 메커니즘 테스트

## 전제조건
- ✅ 유효한 테스트용 API 키 준비 (Spoonacular, Edamam, Custom AI)
- ✅ 무효한/만료된 API 키 준비 (에러 테스트용)
- ✅ 외부 API 엔드포인트 접근 가능
- ✅ 네트워크 연결 상태 제어 가능 (개발자 도구 또는 프록시)

## 테스트 데이터
```javascript
// 테스트용 API 키 (실제로는 환경변수에서 로드)
const TEST_API_KEYS = {
  valid: {
    spoonacular: process.env.SPOONACULAR_TEST_KEY,
    edamamAppId: process.env.EDAMAM_TEST_APP_ID,
    edamamAppKey: process.env.EDAMAM_TEST_APP_KEY,
    customAI: process.env.CUSTOM_AI_TEST_KEY
  },
  invalid: {
    spoonacular: 'invalid_key_12345',
    edamamAppId: 'invalid_app_id',
    edamamAppKey: 'invalid_app_key_12345678901234567890',
    customAI: 'sk-invalid_key_12345'
  },
  malformed: {
    spoonacular: 'short', // 너무 짧은 키
    edamamAppId: '', // 빈 문자열  
    edamamAppKey: 'invalid-chars-!@#$%', // 특수문자 포함
    customAI: 'your_api_key_here' // 플레이스홀더
  }
}

// 테스트 검색어 및 재료
const TEST_QUERIES = {
  recipes: ['pasta', 'chicken', '김치찌개'],
  ingredients: ['tomato', 'onion', 'cheese'],
  invalidQueries: ['', '   ', '!@#$%^&*()']
}
```

## 테스트 단계

### 1단계: API 키 유효성 검사 기능 테스트
**목표**: 입력된 API 키의 형식과 유효성을 정확히 판단하는지 확인

**액션**:
1. 설정 페이지 접속 (`/settings`)
2. 각 API 키 입력 필드에 잘못된 형식의 키 입력
3. 실시간 유효성 검사 결과 확인
4. 유효한 API 키 입력 후 검증 결과 확인

**검증 포인트**:
- ✅ Spoonacular API 키 형식 검증 (32자 이상, 16진수)
- ✅ Edamam App ID/Key 길이 및 형식 검증
- ✅ Custom AI API 키 형식 검증 (sk- 접두사, 최소 길이)
- ✅ 빈 문자열, 플레이스홀더, 특수문자 포함 키 거부
- ✅ 유효한 키 입력 시 시각적 피드백 제공

**예상 결과**:
```javascript
// useSettings.ts의 validateApiKeys 함수 테스트 결과
{
  spoonacular: false,  // malformed key
  edamam: false,      // invalid app id/key 
  customAI: false     // placeholder key
}

// 유효한 키 입력 후
{
  spoonacular: true,
  edamam: true, 
  customAI: true
}
```

### 2단계: Spoonacular API 레시피 검색 테스트
**목표**: Spoonacular API를 통한 레시피 검색 기능이 정상 작동하는지 확인

**액션**:
1. 유효한 Spoonacular API 키 설정
2. 검색 페이지 이동 (`/search`)
3. 검색어 'pasta' 입력 후 검색 실행
4. 로딩 상태 및 결과 표시 확인
5. 레시피 카드 클릭하여 상세 정보 확인

**검증 포인트**:
- ✅ API 호출 중 로딩 스피너 표시
- ✅ 검색 결과 카드들이 grid 레이아웃으로 표시
- ✅ 각 레시피 카드에 이미지, 제목, 요약 정보 포함
- ✅ 레시피 카드 클릭 시 상세 페이지로 이동
- ✅ 상세 페이지에서 재료, 조리법, 영양정보 표시

**예상 결과**:
- 5-20개의 파스타 관련 레시피 결과 반환
- 각 결과에 이미지 URL, 제목, 조리시간, 인분 수 포함
- 상세 페이지에서 완전한 레시피 정보 표시

### 3단계: Custom AI 레시피 생성 테스트  
**목표**: Custom AI API를 통한 레시피 생성 기능 검증

**액션**:
1. 유효한 Custom AI API 키 설정
2. 레시피 생성 페이지 이동 (`/generate`)
3. 재료 목록 입력 (토마토, 양파, 치즈)
4. 선호도 설정 (한식, 30분 이내, 2인분)
5. '레시피 생성' 버튼 클릭
6. 생성 과정 및 결과 확인

**검증 포인트**:
- ✅ 재료 입력 시 자동완성 또는 태그 형태로 추가됨
- ✅ 생성 중 프로그레스 바 또는 로딩 애니메이션 표시
- ✅ AI가 생성한 레시피가 적절한 형식으로 표시
- ✅ 생성된 레시피에 제목, 재료, 단계별 조리법 포함
- ✅ 즐겨찾기 추가 기능 정상 작동

**예상 결과**:
```javascript
// 예상 AI 응답 형식
{
  title: "토마토 양파 치즈 볶음",
  ingredients: [
    "토마토 2개",
    "양파 1개", 
    "치즈 100g"
  ],
  instructions: [
    "양파를 얇게 썬다",
    "팬에 기름을 두르고 양파를 볶는다",
    // ... 추가 단계들
  ],
  cookingTime: "25분",
  servings: 2
}
```

### 4단계: API 키 오류 시나리오 테스트
**목표**: 잘못된 API 키 사용 시 적절한 에러 핸들링이 이뤄지는지 확인

**액션**:
1. 설정에서 무효한 Spoonacular API 키 입력
2. 레시피 검색 시도
3. 401 Unauthorized 에러 응답 확인
4. 사용자에게 표시되는 에러 메시지 확인
5. 에러 발생 후 재시도 옵션 확인

**검증 포인트**:
- ✅ API 호출 실패 시 로딩 상태 해제
- ✅ 사용자 친화적인 에러 메시지 표시 ("API 키를 확인해 주세요")
- ✅ 기술적 에러 내용은 콘솔에만 기록
- ✅ "설정으로 가기" 또는 "재시도" 버튼 제공
- ✅ 에러 토스트/알림이 자동으로 사라짐

**예상 결과**:
```javascript
// 에러 메시지 예시
{
  type: 'api_error',
  message: 'API 키가 유효하지 않습니다. 설정을 확인해 주세요.',
  action: {
    label: '설정으로 이동',
    onClick: () => navigate('/settings')
  }
}
```

### 5단계: 네트워크 연결 실패 시나리오 테스트
**목표**: 네트워크 연결이 불안정하거나 차단된 상황에서의 에러 핸들링 확인

**액션**:
1. 개발자 도구에서 네트워크 "Slow 3G" 설정
2. 레시피 검색 실행
3. 응답 지연 상황 확인
4. 네트워크 완전 차단 (Offline) 설정
5. API 호출 시 에러 처리 확인

**검증 포인트**:
- ✅ 느린 네트워크에서도 30초 이내 타임아웃 설정
- ✅ 네트워크 에러 시 "연결을 확인해 주세요" 메시지 표시  
- ✅ 자동 재시도 메커니즘 동작 (최대 3회)
- ✅ 재시도 간격이 적절함 (2초, 4초, 8초)
- ✅ 최종 실패 시 수동 재시도 옵션 제공

**예상 결과**:
- 네트워크 지연 시에도 사용자에게 적절한 피드백 제공
- 완전한 연결 실패 시 오프라인 모드 또는 재시도 옵션 제시

### 6단계: API 응답 타임아웃 테스트
**목표**: API 서버 응답이 비정상적으로 지연될 때의 처리 확인

**액션**:
1. 네트워크 속도를 매우 느림으로 설정 (Slow 3G 이하)
2. 복잡한 AI 레시피 생성 요청 (많은 재료, 복잡한 조건)
3. 타임아웃 발생 대기 (보통 30-60초 설정)
4. 타임아웃 후 에러 처리 확인
5. 부분적으로 로드된 데이터 처리 확인

**검증 포인트**:
- ✅ 설정된 타임아웃 시간 내에 요청 중단
- ✅ 타임아웃 발생 시 명확한 메시지 표시
- ✅ 진행 중이던 작업이 깔끔하게 정리됨
- ✅ 사용자가 재시도하거나 다른 작업을 할 수 있음
- ✅ 부분 응답이 있을 경우 적절히 처리

**예상 결과**:
```javascript
// 타임아웃 에러 처리 예시
{
  error: 'timeout',
  message: '요청 시간이 초과되었습니다. 다시 시도해 주세요.',
  canRetry: true,
  partialData: null
}
```

### 7단계: 동시 다중 API 호출 테스트
**목표**: 여러 API를 동시에 호출할 때의 안정성과 성능 확인

**액션**:
1. 여러 탭에서 동시에 레시피 검색 실행
2. 검색과 레시피 생성을 동시에 수행
3. API 호출 큐잉 및 처리 순서 확인
4. 메모리 사용량 및 응답 시간 모니터링

**검증 포인트**:
- ✅ 동시 API 호출이 서로 간섭하지 않음
- ✅ API 호출 큐가 적절히 관리됨
- ✅ 메모리 누수 없이 안정적 동작
- ✅ 응답 시간이 단일 호출 대비 2배 이내
- ✅ 에러 발생 시 다른 호출에 영향 없음

**예상 결과**:
- 모든 API 호출이 독립적으로 처리되고 적절한 응답 시간 유지

### 8단계: API 응답 데이터 검증 테스트
**목표**: API에서 반환되는 데이터의 구조와 내용이 예상과 일치하는지 확인

**액션**:
1. 다양한 검색어로 Spoonacular API 테스트
2. 반환된 데이터 구조 검증
3. 필수 필드 존재 여부 확인  
4. 데이터 타입 검증
5. 잘못된 응답 데이터 처리 확인

**검증 포인트**:
- ✅ 필수 필드들이 모두 존재함 (id, title, image, etc.)
- ✅ 데이터 타입이 예상과 일치함
- ✅ null 또는 undefined 값에 대한 기본값 처리
- ✅ 이미지 URL이 유효하고 로드 가능함
- ✅ 잘못된 데이터 구조 시 에러 핸들링

**예상 결과**:
```javascript
// Spoonacular API 응답 검증 스키마
const SPOONACULAR_RECIPE_SCHEMA = {
  id: 'number',
  title: 'string',
  image: 'string', // 유효한 URL
  readyInMinutes: 'number',
  servings: 'number',
  sourceUrl: 'string'
}
```

## 성공 기준
- 모든 유효한 API 키로 정상적인 데이터 수신 (성공률 95% 이상)
- 무효한 API 키에 대해 적절한 에러 메시지 표시
- 네트워크 에러 시 사용자 친화적 메시지 및 재시도 옵션 제공
- API 타임아웃 시 30초 이내 적절한 처리
- 동시 API 호출 시에도 안정적 동작 유지

## 실패 시나리오
1. **API 키 검증 실패**: 유효하지 않은 키가 통과되거나 유효한 키가 거부됨
2. **에러 메시지 누락**: API 오류 발생 시 사용자에게 피드백이 제공되지 않음
3. **타임아웃 미처리**: 장시간 응답 없음에도 무한 대기 상태
4. **데이터 표시 오류**: API 응답이 있으나 UI에 올바르게 표시되지 않음
5. **메모리 누수**: 다중 API 호출 후 메모리 사용량이 지속적으로 증가

## 추가 고려사항

### 보안 측면
- API 키가 브라우저 개발자 도구에 노출되지 않도록 주의
- API 응답에서 민감한 정보 필터링
- CORS 정책 준수 확인

### 성능 최적화  
- API 응답 캐싱 전략 (1시간 캐시 권장)
- 이미지 지연 로딩 및 압축
- 불필요한 API 호출 방지 (디바운싱)

### 모니터링 및 로깅
- API 호출 성공/실패 통계 수집
- 응답 시간 모니터링
- 에러 발생 빈도 추적

---
**작성일**: 2024년 8월 23일  
**작성자**: AI Recipe E2E Test Team  
**문서 버전**: 1.0  
**테스트 환경**: Chrome 127+, localhost:5179